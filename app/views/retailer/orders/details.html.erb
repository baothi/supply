<% content_for :title, "Order-#{@order.number}" %>
<% content_for :main_menu, Hingeto::Section::ORDERS %>
<body class="animsition page-aside-static page-aside-left">
<%= render "shared/outdated_browser" %>
<%= render "shared/nav_bar" %>
<%= render "retailer/shared/side_menu" %>
<%= render "shared/grid_menu" %>

<div class="page">
  <div class="page-main">
    <div class="page-header">
      <h1 class="page-title">Order <%= @order.retailer_shopify_name %></h1>
      <% if admin_user? %>
        <span class="tag tag-success"><%= @order.supplier&.platform %></span>
      <% end %>
    </div>


    <div class="page-content">
        <%= render :partial=>"shared/spaced_alerts" %>

      <% if @order.archived? %>
      <div class="row">
        <div class="col-sm-12">
          <div class="alert alert-warning alert-dismissible dark col-sm-12">
            This order was archived on <%= @order.archived_at %>
          </div>
        </div>
      </div>
      <% end %>


      <div class="panel nav-tabs-horizontal" data-plugin="tabs">



        <div class="panel-body">
          <div class="row" style="padding-bottom:20px;">
            <div class="col-xs-12">
              <div class="text-xs-right">
              <% if @order.successfully_sent_order? %>
                <% if @order.shipment_state != 'canceled' && @order.shipment_state != 'shipped' %>
                    <button type="button" class="btn btn-default btn-outline" data-target="#addTracking" data-toggle="modal">
                      <span><i class="icon fa-truck" aria-hidden="true"></i>Add Tracking</span>
                    </button>
                <% end %>
              <% end %>

              <% if @order.shopify_order? %>
                <% if  @order.paid? && !@order.cancelled? %>
                  <%= link_to retailer_import_order_fulfillment_path(order_id: @order.internal_identifier) do %>
                    <button type="button" class="btn btn-primary btn-danger btn-dark">
                    <span><i class="icon fa-download" aria-hidden="true"></i>Get Fulfillment</span>
                      </button>
                  <% end %>
                <% end %>

                <% if @order.shipped? %>
                  <%= link_to retailer_export_order_fulfillment_path(order_id: @order.internal_identifier) do %>
                  <button type="button" class="btn btn-primary btn-danger btn-dark">
                    <span><i class="icon fa-upload" aria-hidden="true"></i>Export Fulfillment To Shopify</span>
                  </button>
                  <% end %>
                <% end %>
              <% end %>
                <!--<button type="submit" class="btn btn-animate btn-animate-side btn-primary btn-danger">-->
                <!--<button type="button" onclick="javascript:confirm('Are you sure you want to cancel?');" class="btn btn-primary btn-danger btn-dark">-->
                <!--<span>-->
                <!--<i class="icon fa-exclamation-circle" aria-hidden="true"></i> Cancel All</span>-->
                <!--</button>-->
                <!-- &nbsp;&nbsp;
                <button type="button" class="btn btn-default btn-outline" data-target="#addTracking" data-toggle="modal">
                  <span><i class="icon fa-truck" aria-hidden="true"></i>Add Tracking</span>
                </button> -->
                <% if !@order.paid? && @order.eligible_for_ordering_based_on_country? &&
                    !@order.successfully_sent_order? && !@order.error? && !@order.cancelled? %>
                &nbsp;&nbsp;
                <a href="#" data-toggle="modal" data-target="#payWith" class="open-order-payment-modal"  data-amount= "<%= @order.grand_total %>" data-customer="<%= @order.email %>" data-date="<%= @order.completed_at %>" data-order="<%= @order.number %>" data-identifier="<%= @order.internal_identifier %>">
                  <button type="button" class="btn btn-default btn-outline"  data-toggle="modal">
                  <span><i class="icon fa-money" aria-hidden="true"></i> Pay</span>
                </button></a>
                <% elsif !@order.eligible_for_ordering_based_on_country? %>
                    <button  type="button" class="btn btn-danger btn-sm"
                             data-toggle="modal" data-target="#international-<%= @order.internal_identifier %>">View Errors</button>

                    <%= render partial: 'retailer/orders/shared/modal/international_order', locals: {order: @order} %>

              <% end %>
                &nbsp;&nbsp;
                <button type="button" class="btn btn-default btn-outline" onclick="javascript:window.print();">
                  <span><i class="icon fa-print" aria-hidden="true"></i>Print</span>
                </button>

                <% if @order.retailer_id == ENV['INTERNAL_RETAILER_ID'].to_i %>
                  <%= link_to retailer_remove_shipping_and_set_cost_path(order_id: @order.internal_identifier,  amount_in_cents: 1167) do %>
                    <button type="button" class="btn btn-success">
                      <span><i class="icon fa-print" aria-hidden="true"></i>Remove Shipping & Set all costs to $11.67</span>
                    </button>
                  <% end %>
                <% end %>

                <% if @order.retailer_id == ENV['INTERNAL_RETAILER_ID'].to_i %>
                    <%= link_to retailer_remove_shipping_and_set_cost_path(order_id: @order.internal_identifier, amount_in_cents: 1100) do %>
                        <button type="button" class="btn btn-success">
                          <span><i class="icon fa-print" aria-hidden="true"></i>Remove Shipping & Set all costs to $11</span>
                        </button>
                    <% end %>
                <% end %>

                <% if @order.paid? && @order.successfully_sent_order? && @order.order_issue_report.blank? %>
                  <%= link_to retailer_open_issue_report_modal_path(@order.internal_identifier), remote: true, class: "" do %>
                    <button type="button" class="btn btn-warning btn-outline">Report Issue</button>
                  <% end %>
                <% end %>
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-lg-3 col-xs-12">
              <!--<h4>-->
                <!--<img class="m-r-10" src="../../assets//images/logo-blue.png" alt="...">Remark</h4>-->
              <!---->
              <% address = @order.shipping_address %>
              <% if address.present? %>
                <address>
                  <%= address.full_name %><br><%= address.address1 %><%= ", #{address.address2}" if address.address2.present? %>

                  <br><%= address_full(@order.shipping_address) %>
                  <br>
                  <!--<abbr title="Mail">E-mail:</abbr>&nbsp;&nbsp;user@pacsundropship.com-->
                  <abbr title="Phone">Phone:</abbr>&nbsp;&nbsp;<%= address.phone %>
                </address>
              <% end %>
            </div>
            <div class="col-xs-12 col-lg-3 offset-lg-6 text-xs-right">
              <span>Order Date: <%= @order.completed_at.strftime("%B %d, %Y") unless @order.completed_at.nil? %></span>
              <br>
              <span class="tag <%= shipping_status_tag_class(@order.shipment_state) %>"><%= translate_to_shopify_shipping_status(@order.shipment_state)  %></span>
              &nbsp;&nbsp;
              <% payment_state_display = @order.payment_state_display %>
              <span class="tag <%= tag_class(@order.paid?) %>"><%= payment_state_display.humanize unless payment_state_display.nil? %></span>

              <% if @order.paid? && @order.successfully_sent_order? && @order.order_issue_report.present? %>
                &nbsp;&nbsp;
                <% if @order.order_issue_report.resolved? %>
                  <% if @order.order_issue_report.declined? %>
                    <span class="tag tag-danger">Issue Reported | Declined</span>
                  <% else %>
                    <span class="tag tag-success">Issue Reported | Credited</span>
                  <% end %>
                <% else %>
                  <span class="tag tag-warning">Issue Reported | Pending Decision</span>
                <% end %>
              <% end %>

      <% if @order.in_remittance_process? && !@order.paid_and_fulfilled? %>
                <span class="tag tag-pill tag-warning">We are currently processing this order.</span>
              <% end %>
              <!-- <br>
              <span>Fulfill by Date: January 22, 2017</span> -->
              <br>
              <span>Tracking #: <%= @order.tracking_numbers %></span>
            </div>
          </div>
          <div class="page-invoice-table table-responsive">
            <%= render 'line_items' %>
          </div>
          <div class="text-xs-right clearfix">
            <div class="pull-xs-right">
              <p>Sub - Total amount:
                <span><%= number_to_currency @order.total_cost_price_without_shipping %></span>
              </p>
              <!-- <p>Discounts:
                <span>$35</span>
              </p> -->
              <p>Processing Fee:
                <span><%= number_to_currency @order.processing_fee %></span>
              </p>
              <p>Shipping:
                <span><%= number_to_currency @order.total_shipping %></span>
              </p>
              <!-- <p>Shipping:
                <span>$35</span>
              </p> -->
              <p class="page-invoice-amount">Grand Total:
                <span><%= number_to_currency (@order.total_cost_price_with_shipping) %></span>
              </p>
              <% if @order.paid? %>
                <% if @order.total_discount.positive? %>
                  <p class="page-invoice-amount">Applied Discount:
                    <span><%= number_to_currency (@order.total_discount) %></span>
                  </p>
                <% end %>
                <p class="page-invoice-amount">Amount Paid:
                  <span><%= number_to_currency (@order.payment_total) %></span>
                  <% if @order.has_refunds? %>
                    <br>
                    <span style="color:red;">This order has refunds (See below)</span>
                  <% end %>
                </p>
              <% end %>
            </div>
          </div>

        </div>
      </div>

      <%= render partial: "retailer/orders/more_information" %>

      <% if admin_user? %>
          <%= render "retailer/orders/debug/line_items", line_items: @order.line_items %>
      <% end %>

      <% if @order.order_risks.present? %>
        <%= render 'retailer/orders/debug/order_risks', order: @order %>
      <% end %>

      <% if @order.has_refunds? %>
          <%= render 'retailer/orders/debug/order_refunds', order: @order %>
      <% end %>

      <% if admin_user? %>
      <!-- Order Diagnosis -->
      <div class="row">
        <div class="col-xxl-9 col-xl-8 col-lg-12 col-xs-12">
          <%= render partial: "retailer/orders/debug/logs" %>
          <%= render partial: "retailer/orders/debug/shopify_information" %>
          <%= render partial: "retailer/orders/debug/other" %>
        </div>
        <div class="col-xxl-3 col-xl-4 col-lg-12 col-xs-12">
          <!-- add buttons -->
          <%= render partial: "retailer/orders/debug/actions" %>

        </div>
      </div>
      <!-- End Order Diagnosis -->

      <% end %>

    </div>

  </div>
</div>

<%= render partial: "retailer/orders/shared/fulfillment_modal" %>
<div class='order-payments-modals'>
  <% if current_retailer == @order.retailer %>
    <%= render "retailer/orders/shared/pay_with" %>
  <% else %>
    <%= render "retailer/orders/shared/cross_retailer_payment_error" %>
  <% end %>

  <div class="new-payment-methods-div">
    <%= render "retailer/orders/shared/payment_methods" %>
  </div>
  <%= render "retailer/orders/shared/new_payment_method" %>
</div>


<%= render "shared/platform/footer" %>
</body>
<%= render "layouts/shared/stripe_tags" %>

<div id="report-modal-base"></div>
